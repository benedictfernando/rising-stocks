var db=firebase.firestore(),docRef=db.collection("users");function index(e){var t=document.getElementById("tableUsername"),o=document.getElementById("tableUsercash"),n=document.getElementById("tableUsertotal"),s=document.querySelector("tbody"),r=e.uid;document.title+=" Portfolio",t.innerHTML=e.displayName+" (You)";var a=docRef.doc(r);a.onSnapshot(function(t){if(t.exists){var r=0,i=t.data(),l=i.portfolio;l.sort(dynamicSort("symbol")),o.innerHTML=formatMoney(i.cash);for(let e=0,t=l.length;e<t;e++)if(l[e].shares>0){var c=s.insertRow(),d=document.createTextNode(l[e].symbol);c.insertCell().appendChild(d),d=document.createTextNode(l[e].company),c.insertCell().appendChild(d),d=document.createTextNode(l[e].shares),c.insertCell().appendChild(d),d=document.createTextNode(formatMoney(l[e].price)),c.insertCell().appendChild(d);var m=l[e].shares*l[e].price;d=document.createTextNode(formatMoney(m)),c.insertCell().appendChild(d),r+=m}n.innerHTML=`<b>${formatMoney(r+i.cash)}</b>`}else a.set({name:e.displayName,cash:1e4,portfolio:[]})})}function quote(e){var t=document.getElementById("detailsDiv"),o=document.getElementById("detailsInfo"),n=document.getElementById("detailsName"),s=document.getElementById("detailsSymbol"),r=document.getElementById("detailsPrice");document.title+=" Quote",document.querySelector("form").onsubmit=function(){t.style.display="none",o.style.display="inline",o.innerHTML="<br>Getting stock quotation...";var e=document.getElementById("symbol").value.toUpperCase();return fetch(`https://risingstocks.000webhostapp.com/lookup.php?symbol=${e}`).then(a=>{a.json().then(o=>{t.style.display="inline",s.innerHTML=e,n.innerHTML=o.companyName,r.innerHTML=formatMoney(o.latestPrice)}).catch(e=>{notify({message:"Invalid stock.",color:"danger"}),console.log(`${e.code}: ${e.message}`)}),o.style.display="none"}),!1}}function buy(e){var t=document.getElementById("detailsInfo");document.title+=" Buy",document.querySelector("form").onsubmit=function(){t.style.display="inline",t.innerHTML="<br>Processing transaction...";var o=document.getElementById("shares").value;if(!isPositiveInteger(o))return t.style.display="none",notify({message:"Nope.",color:"danger"}),!1;if(0==o)return t.style.display="none",notify({message:"Can't buy no stock.",color:"danger"}),!1;o=parseInt(o);var n=document.getElementById("symbol").value.toUpperCase();return fetch(`https://risingstocks.000webhostapp.com/lookup.php?symbol=${n}`).then(s=>{s.json().then(s=>{var r=s.companyName,a=s.latestPrice,i=a*o,l=docRef.doc(e.uid);l.get().then(e=>{var s=e.data(),c=s.cash,d=s.portfolio;if(i>c)return t.style.display="none",notify({message:"Not enough funds.",color:"danger"}),!1;var m=d.findIndex(function(e,t){if(e.symbol===n)return!0});if(-1===m){var y={symbol:n,company:r,shares:o,price:a};d.push(y)}else d[m].price=a,d[m].shares+=o;l.set({cash:c-i,portfolio:d},{merge:!0}).then(()=>{notify({message:"Stock bought!",color:"success"}),setTimeout(()=>location.href="/index.html",500)}).catch(e=>{notify({message:"Error completing transaction."}),console.log(`${e.code}: ${e.message}`)})}).catch(e=>{notify({message:"Transaction error.",color:"danger"}),console.log(`${e.code}: ${e.message}`)})}).catch(e=>{notify({message:"Invalid stock.",color:"danger"}),console.log(`${e.code}: ${e.message}`)}),t.style.display="none"}),!1}}function sell(e){var t=document.getElementById("detailsInfo"),o=document.querySelector("select"),n=document.querySelector("form");document.title+=" Sell";var s=docRef.doc(e.uid);s.get().then(e=>{var r=e.data(),a=r.portfolio,i=a;if(i.sort(dynamicSort("symbol")),i.length){for(let e=0,t=i.length;e<t;e++)if(i[e].shares>0){var l=document.createElement("option");l.value=i[e].symbol,l.innerHTML=`${i[e].symbol} (${i[e].shares})`,o.appendChild(l)}}else{var c=n.elements;t.style.display="inline",t.innerHTML="<br>You don't own any stock(s) yet.",n.querySelectorAll(":scope > button").forEach(e=>{e.disabled=!0});for(let e=0,t=c.length;e<t;e++)c[e].readOnly=!0}n.onsubmit=function(){t.style.display="inline",t.innerHTML="<br>Processing transaction...";var e=document.getElementById("shares").value;if(!isPositiveInteger(e))return t.style.display="none",notify({message:"Nope.",color:"danger"}),!1;if(0==e)return t.style.display="none",notify({message:"Can't sell no stock.",color:"danger"}),!1;e=parseInt(e);var o=document.getElementById("symbol").value.toUpperCase();return fetch(`https://risingstocks.000webhostapp.com/lookup.php?symbol=${o}`).then(n=>{n.json().then(n=>{var i=a.findIndex(function(e,t){if(e.symbol===o)return!0});if(-1===i||a[i].shares<1)return t.style.display="none",notify({message:`You don't have ${o} stock(s) yet.`,color:"danger"}),!1;if(a[i].shares<e)return t.style.display="none",notify({message:"Not enough stocks.",color:"danger"}),!1;var l=n.latestPrice,c=l*e,d=r.cash;a[i].shares-=e,a[i].price=l,s.set({cash:d+c,portfolio:a},{merge:!0}).then(()=>{notify({message:"Stock sold!",color:"success"}),setTimeout(()=>location.href="/index.html",500)}).catch(e=>{notify({message:"Error completing transaction."}),console.log(`${e.code}: ${e.message}`)})}),t.style.display="none"}),!1}}).catch(e=>{notify({message:"Error getting data.",color:"danger"}),console.log(`${e.code}: ${e.message}`)})}function history(e){document.title+=" History"}function navbar(e){var t=document.getElementById("navUsername"),o=document.getElementById("navUserimage");t&&o&&(t.innerHTML="Hi, "+e.displayName.split(" ").shift()+"!",o.src=`${e.photoURL}`,o.style.width="42px",o.style.borderRadius="10px")}function formatMoney(e,t,o,n){t=isNaN(t=Math.abs(t))?2:t,o=void 0===o?".":o,n=void 0===n?",":n;var s=e<0?"-":"",r=String(parseInt(e=Math.abs(Number(e)||0).toFixed(t))),a=(a=r.length)>3?a%3:0;return s+"$"+(a?r.substr(0,a)+n:"")+r.substr(a).replace(/(\decSep{3})(?=\decSep)/g,"$1"+n)+(t?o+Math.abs(e-r).toFixed(t).slice(2):"")}function dynamicSort(e){var t=1;return"-"===e[0]&&(t=-1,e=e.substr(1)),function(o,n){return(o[e]<n[e]?-1:o[e]>n[e]?1:0)*t}}function isPositiveInteger(e){return e>>>0===parseFloat(e)}